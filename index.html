<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Current Due Task — Daily Reset Tracker</title>
<link rel="icon" href="data:,">
<style>
  :root{
    --bg:#0f1220; --card:#161b2b; --ink:#eef1ff; --muted:#9aa3c7; --line:#2a3052;
    --accent:#6ca8ff; --ok:#7bd88f; --warn:#ffd166; --bad:#ff7575;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
  a{color:var(--accent);text-decoration:none}
  .wrap{max-width:1100px;margin:24px auto;padding:0 14px}
  header{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;margin-bottom:12px}
  h1{font-size:18px;margin:0}
  .panel{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:12px;box-shadow:0 0 0 1px rgba(0,0,0,.05) inset}
  .controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  button{background:var(--accent);color:#06102a;border:0;border-radius:10px;padding:8px 12px;font-weight:700;cursor:pointer}
  button.secondary{background:#202a44;color:var(--ink);border:1px solid var(--line);font-weight:600}
  button.small{padding:4px 8px;border-radius:8px;font-size:12px}
  table{width:100%;border-collapse:separate;border-spacing:0 8px}
  thead th{font-size:12px;color:var(--muted);text-align:left;padding:0 10px}
  tbody td{background:#101731;border:1px solid var(--line);padding:10px;border-left:0;border-right:0}
  tbody tr td:first-child{border-left:1px solid var(--line);border-radius:10px 0 0 10px}
  tbody tr td:last-child{border-right:1px solid var(--line);border-radius:0 10px 10px 0}
  input[type="text"]{width:100%;background:#0b1128;border:1px solid var(--line);color:var(--ink);
    padding:8px 10px;border-radius:8px;outline:none}
  input[type="text"]::placeholder{color:#6b7280}
  .center{display:flex;align-items:center;justify-content:center}
  .badge{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--line);background:#0b1128;color:#9aa3c7;font-size:12px}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .kpi{display:flex;align-items:center;gap:10px;padding:10px;border:1px solid var(--line);border-radius:10px;background:#0b1128}
  .kpi .n{font-weight:800;font-size:18px}
  .kpi .label{color:#9aa3c7;font-size:12px}
  .right{text-align:right}
  .del{background:#23121a;color:#ffd6da;border:1px solid #4b1a23}
  .foot{display:flex;justify-content:flex-end;margin-top:6px;color:#9aa3c7;font-size:12px}
  .checkbox{transform:scale(1.25)}

  /* Tabs */
  .tabs{display:flex;gap:6px;margin-bottom:10px;flex-wrap:wrap}
  .tabbtn{background:#202a44;color:var(--ink);border:1px solid var(--line);border-radius:999px;padding:6px 10px;font-size:12px;cursor:pointer}
  .tabbtn.active{background:var(--accent);color:#06102a;border-color:transparent}
  .hidden{display:none}
  textarea.syncbox{width:100%;min-height:140px;background:#0b1128;border:1px solid var(--line);color:var(--ink);border-radius:10px;padding:10px}
  .hint{color:#9aa3c7;font-size:12px;margin-top:6px}
  .danger{background:#3b1a1f;color:#ffd6da;border:1px solid #5b1d27}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>Current Due Task</h1>
    <div class="controls">
      <span class="badge" id="todayLabel"></span>
      <span class="badge" id="activeTopicsBadge" title="Topics not checked as done">Active Topics: 0</span>
      <button id="addRow">+ Add Row</button>
      <button id="resetToday" class="secondary">Reset Today</button>
    </div>
  </header>

  <!-- Tabs -->
  <div class="tabs">
    <button class="tabbtn active" data-tab="tracker">Tracker</button>
    <button class="tabbtn" data-tab="sync">Manual Sync</button>
  </div>

  <!-- Tab: Tracker (original UI) -->
  <div id="tab-tracker">
    <section class="panel">
      <table>
        <thead>
          <tr>
            <th style="width:34px">#</th>
            <th>Subject</th>
            <th>Active Topic</th>
            <th class="center" title="Mark when a planned chunk is completed">Due Topic Chunk</th>
            <th class="center" title="Mark when today's topic is finished">Topic Done</th>
            <th class="center" title="Mark when the whole subject is done">Subject Done</th>
            <th style="width:64px"></th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
      <div class="foot">Autosaves to your browser. Checkboxes reset at midnight.</div>
    </section>

    <h2 style="font-size:16px;margin:18px 0 8px">Today Progress Report</h2>
    <section class="panel">
      <div class="grid">
        <div class="kpi">
          <div class="n" id="chunksDoneN">0</div>
          <div><div class="label">Chunks completed today</div><div class="label">Total today: <span id="chunksTotalN">0</span></div></div>
        </div>
        <div class="kpi">
          <div class="n" id="topicsDoneN">0</div>
          <div><div class="label">Topics done today</div><div class="label">Total active: <span id="topicsActiveN">0</span></div></div>
        </div>
        <div class="kpi">
          <div class="n" id="subjectsDoneN">0</div>
          <div><div class="label">Subjects done today</div><div class="label">Total active: <span id="subjectsActiveN">0</span></div></div>
        </div>
      </div>
    </section>
  </div>

  <!-- Tab: Manual Sync -->
  <div id="tab-sync" class="hidden">
    <section class="panel">
      <h2 style="font-size:16px;margin:0 0 10px">Manual Sync</h2>
      <div class="controls" style="margin-bottom:10px;flex-wrap:wrap">
        <button id="exportBtn">Export JSON</button>
        <button id="copyBtn" class="secondary">Copy JSON</button>
        <input type="file" id="fileInput" accept="application/json" style="display:none">
        <button id="importFileBtn" class="secondary">Import from File</button>
      </div>

      <textarea id="pasteBox" class="syncbox" placeholder='Paste exported JSON here to import…'></textarea>
      <div class="controls" style="margin-top:8px;flex-wrap:wrap">
        <button id="importReplace" class="danger">Import (Replace All)</button>
        <button id="importMerge" class="secondary">Import (Merge Status Only)</button>
      </div>
      <div class="hint">
        <b>Replace All</b>: overwrites tasks, counters, and all per-day statuses.<br>
        <b>Merge Status Only</b>: keeps your current tasks and counters, and only merges in any <code>cdt_status_YYYY-MM-DD</code> maps from the JSON.
      </div>
    </section>
  </div>
</div>

<script>
(() => {
  // Keys
  const TASKS_KEY = "cdt_tasks_v1";
  const NEXTID_KEY = "cdt_nextid_v1";
  const LASTDATE_KEY = "cdt_last_date_v1";
  const statusKey = k => `cdt_status_${k}`;
  const dateKey = (d=new Date()) => {
    const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), dd=String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${dd}`;
  };

  // Storage helpers
  const loadTasks = () => { try { return JSON.parse(localStorage.getItem(TASKS_KEY)||"[]"); } catch { return []; } };
  // allow saving without re-render (prevents iPad keyboard glitches)
  const saveTasks = (a, {rerender=true} = {}) => {
    localStorage.setItem(TASKS_KEY, JSON.stringify(a));
    if (rerender) render();
  };
  const nextId = () => { const n=+(localStorage.getItem(NEXTID_KEY)||"1"); localStorage.setItem(NEXTID_KEY,String(n+1)); return n; };
  const loadStatus = dk => { try { return JSON.parse(localStorage.getItem(statusKey(dk))||"{}"); } catch { return {}; } };
  const saveStatus = (dk,obj) => { localStorage.setItem(statusKey(dk), JSON.stringify(obj)); updateKPIs(); };

  // Lightweight, de-bounced local save for typing
  let _typeSaveTimer = null;
  function debouncedSaveLocal(tasks){
    if (_typeSaveTimer) clearTimeout(_typeSaveTimer);
    _typeSaveTimer = setTimeout(() => {
      saveTasks(tasks, {rerender:false});
    }, 150);
  }

  // DOM refs
  const $rows = document.getElementById("rows");
  const $addRow = document.getElementById("addRow");
  const $resetToday = document.getElementById("resetToday");

  // Tabs
  const $tabBtns = document.querySelectorAll(".tabbtn");
  const $tabTracker = document.getElementById("tab-tracker");
  const $tabSync = document.getElementById("tab-sync");
  $tabBtns.forEach(btn => {
    btn.addEventListener("click", () => {
      $tabBtns.forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      const t = btn.dataset.tab;
      if (t === "tracker"){ $tabTracker.classList.remove("hidden"); $tabSync.classList.add("hidden"); }
      else { $tabSync.classList.remove("hidden"); $tabTracker.classList.add("hidden"); }
    });
  });

  // Render tracker table
  function render(){
    const tasks = loadTasks();
    const dk = dateKey();
    const st = loadStatus(dk);

    document.getElementById("todayLabel").textContent = `Today: ${dk}`;
    $rows.innerHTML = "";

    tasks.forEach((t, i) => {
      const s = st[t.id] || {chunk:false, topic:false, subject:false};
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="center">${i+1}</td>
        <td><input type="text" placeholder="Subject…" value="${t.subject||""}" autocomplete="off" autocorrect="off" spellcheck="false"></td>
        <td><input type="text" placeholder="Active topic…" value="${t.topic||""}" autocomplete="off" autocorrect="off" spellcheck="false"></td>
        <td class="center"><input class="checkbox" type="checkbox" ${s.chunk?"checked":""}></td>
        <td class="center"><input class="checkbox" type="checkbox" ${s.topic?"checked":""}></td>
        <td class="center"><input class="checkbox" type="checkbox" ${s.subject?"checked":""}></td>
        <td class="right"><button class="small del" title="Delete row">Delete</button></td>
      `;

      // Subject typing -> save to localStorage only (no re-render)
      const subjInput = tr.children[1].querySelector("input");
      subjInput.addEventListener("input", e => { t.subject=e.target.value; debouncedSaveLocal(tasks); });
      subjInput.addEventListener("blur", () => render());

      // Topic typing -> same behavior
      const topicInput = tr.children[2].querySelector("input");
      topicInput.addEventListener("input", e => { t.topic=e.target.value; debouncedSaveLocal(tasks); });
      topicInput.addEventListener("blur", () => render());

      tr.children[3].querySelector("input").addEventListener("change", e => {
        st[t.id] = st[t.id] || {chunk:false, topic:false, subject:false};
        st[t.id].chunk = e.target.checked; saveStatus(dk, st);
      });
      tr.children[4].querySelector("input").addEventListener("change", e => {
        st[t.id] = st[t.id] || {chunk:false, topic:false, subject:false};
        st[t.id].topic = e.target.checked; saveStatus(dk, st);
      });
      tr.children[5].querySelector("input").addEventListener("change", e => {
        st[t.id] = st[t.id] || {chunk:false, topic:false, subject:false};
        st[t.id].subject = e.target.checked; saveStatus(dk, st);
      });

      tr.children[6].querySelector("button").addEventListener("click", () => {
        saveTasks(loadTasks().filter(x => x.id !== t.id)); // default rerender = true
      });

      $rows.appendChild(tr);
    });

    updateKPIs();
  }

  function updateKPIs(){
    const tasks = loadTasks();
    const st = loadStatus(dateKey());
    let chunksDone=0, topicsDone=0, subjectsDone=0;

    tasks.forEach(t => {
      const s = st[t.id] || {chunk:false, topic:false, subject:false};
      if(s.chunk) chunksDone++;
      if(s.topic) topicsDone++;
      if(s.subject) subjectsDone++;
    });

    const totalRows = tasks.length;
    const topicsActive = totalRows - topicsDone;
    const subjectsActive = totalRows - subjectsDone;

    document.getElementById("chunksDoneN").textContent = chunksDone;
    document.getElementById("chunksTotalN").textContent = totalRows;
    document.getElementById("topicsDoneN").textContent = topicsDone;
    document.getElementById("topicsActiveN").textContent = topicsActive;
    document.getElementById("subjectsDoneN").textContent = subjectsDone;
    document.getElementById("subjectsActiveN").textContent = subjectsActive;
    document.getElementById("activeTopicsBadge").textContent = `Active Topics: ${topicsActive}`;
  }

  // Add & Reset
  document.getElementById("addRow").addEventListener("click", () => {
    const tasks = loadTasks();
    tasks.push({ id: (+(localStorage.getItem("cdt_nextid_v1")||"1")), subject:"", topic:"", created: Date.now() });
    localStorage.setItem("cdt_nextid_v1", String((+(localStorage.getItem("cdt_nextid_v1")||"1")) + 1));
    saveTasks(tasks); // rerender
  });

  function clearTodayStatuses(){
    const dk = dateKey();
    localStorage.removeItem(statusKey(dk));
    localStorage.setItem(LASTDATE_KEY, dk);
    render();
  }
  document.getElementById("resetToday").addEventListener("click", () => {
    if(confirm("Reset all today's checkboxes?")) clearTodayStatuses();
  });

  // Midnight auto-reset (local time)
  function ensureToday(){
    const dk = dateKey();
    const last = localStorage.getItem(LASTDATE_KEY);
    if(last !== dk){
      localStorage.setItem(LASTDATE_KEY, dk);
      render(); // new day -> statuses appear unchecked
    }
  }
  setInterval(ensureToday, 60*1000);
  if(!localStorage.getItem(LASTDATE_KEY)) localStorage.setItem(LASTDATE_KEY, dateKey());

  // ---------- Manual Sync helpers ----------
  function collectAll(){
    const data = {
      version: 1,
      exportedAt: new Date().toISOString(),
      items: {}
    };
    // core keys
    data.items[TASKS_KEY] = localStorage.getItem(TASKS_KEY) || "[]";
    data.items[NEXTID_KEY] = localStorage.getItem(NEXTID_KEY) || "1";
    data.items[LASTDATE_KEY] = localStorage.getItem(LASTDATE_KEY) || dateKey();
    // all per-day status maps
    Object.keys(localStorage).forEach(k => {
      if (k.startsWith("cdt_status_")){
        data.items[k] = localStorage.getItem(k);
      }
    });
    return data;
  }

  function downloadJSON(obj, filename="cdt-manual-sync.json"){
    const blob = new Blob([JSON.stringify(obj,null,2)], {type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    setTimeout(() => { URL.revokeObjectURL(a.href); a.remove(); }, 0);
  }

  async function copyJSON(obj){
    try{
      await navigator.clipboard.writeText(JSON.stringify(obj,null,2));
      alert("JSON copied to clipboard.");
    }catch{
      alert("Copy failed. Your browser might block clipboard access.");
    }
  }

  function parsePasted(){
    const txt = document.getElementById("pasteBox").value.trim();
    if(!txt){ alert("Paste JSON first."); return null; }
    try{ return JSON.parse(txt); }catch{ alert("Invalid JSON."); return null; }
  }

  function applyReplaceAll(payload){
    if(!payload || !payload.items){ alert("Bad payload."); return; }
    // wipe all cdt_* keys
    Object.keys(localStorage).forEach(k => {
      if (k.startsWith("cdt_")) localStorage.removeItem(k);
    });
    // write everything from payload
    Object.entries(payload.items).forEach(([k,v]) => {
      localStorage.setItem(k, String(v));
    });
    render();
    alert("Import complete (replaced all).");
  }

  function applyMergeStatusOnly(payload){
    if(!payload || !payload.items){ alert("Bad payload."); return; }
    // merge only cdt_status_* maps; keep current tasks/counters
    Object.entries(payload.items).forEach(([k,v]) => {
      if (k.startsWith("cdt_status_")){
        // if both exist, merge shallowly (per task id flags)
        const incoming = JSON.parse(v || "{}");
        const current = JSON.parse(localStorage.getItem(k) || "{}");
        localStorage.setItem(k, JSON.stringify(Object.assign({}, current, incoming)));
      }
    });
    updateKPIs();
    alert("Import complete (merged statuses).");
  }

  // Sync UI events
  document.getElementById("exportBtn").addEventListener("click", () => downloadJSON(collectAll()));
  document.getElementById("copyBtn").addEventListener("click", () => copyJSON(collectAll()));

  const fileInput = document.getElementById("fileInput");
  document.getElementById("importFileBtn").addEventListener("click", () => fileInput.click());
  fileInput.addEventListener("change", async () => {
    const f = fileInput.files && fileInput.files[0];
    if(!f) return;
    try{
      const txt = await f.text();
      document.getElementById("pasteBox").value = txt;
      alert("File loaded. Review JSON below, then choose an import option.");
    }catch(e){
      alert("Failed to read file.");
    }finally{
      fileInput.value = "";
    }
  });

  document.getElementById("importReplace").addEventListener("click", () => {
    const p = parsePasted(); if(!p) return;
    if(confirm("This will replace ALL tasks and statuses. Continue?")){
      applyReplaceAll(p);
    }
  });
  document.getElementById("importMerge").addEventListener("click", () => {
    const p = parsePasted(); if(!p) return;
    applyMergeStatusOnly(p);
  });

  // initial render
  render();
})();
</script>
</body>
</html>
